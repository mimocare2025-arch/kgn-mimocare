<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KGN Mimo Care — Gallery + QR Scanner</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:12px;background:#f6f8fb;color:#102033}
    h2{margin-bottom:6px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(16,32,51,0.06)}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;margin-top:8px}
    .tab{padding:8px 12px;border-radius:8px;background:#eef6ff;color:#024;cursor:pointer}
    .tab.active{background:#0b67ff;color:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px}
    .thumb{background:#fff;border-radius:8px;padding:8px;border:1px solid #e8f0ff;display:flex;flex-direction:column;gap:8px}
    .thumb img{width:100%;height:140px;object-fit:cover;border-radius:6px;background:#f3f6ff}
    .small{font-size:13px;color:#556}
    .btn{background:#0b67ff;color:#fff;padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .btn-ghost{background:#eef6ff;color:#024;padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;padding:18px}
    .modal-inner{max-width:900px;width:100%;background:#fff;padding:14px;border-radius:10px;position:relative}
    textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #dde6f3}
    #qr-reader{width:320px;margin-top:8px}
    .note{font-size:13px;color:#445;margin-top:8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
  </style>

  <!-- html5-qrcode for scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>
<body>

  <div class="card top">
    <div>
      <h2>KGN Mimo Care — Gallery</h2>
      <div class="note">Upload photos (camera or file). Each image has note + QR. Scan QR to open image.</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="tabs" id="tabs">
        <div class="tab active" data-cat="technicians">Technicians</div>
        <div class="tab" data-cat="shop">Shop</div>
      </div>
      <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">
      <button id="pickBtn" class="btn">Upload / Take Photo</button>
    </div>
  </div>

  <div id="grid" class="grid" style="margin-top:12px"></div>

  <!-- modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-inner">
      <button id="closeModal" style="position:absolute;right:12px;top:12px;background:#ef4444;color:#fff;border:0;padding:6px 8px;border-radius:6px;cursor:pointer">Close</button>
      <div style="display:grid;grid-template-columns:1fr 340px;gap:12px">
        <div>
          <img id="modalImg" src="" alt="" style="width:100%;height:420px;object-fit:contain;border-radius:8px;background:#f3f6ff" />
          <div style="margin-top:8px"><strong id="modalTitle"></strong><div id="modalMeta" class="small"></div></div>
          <div style="margin-top:8px">
            <label>Comment / Note</label>
            <textarea id="modalComment" rows="4" placeholder="Work notes, tech name, serial no..."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveComment" class="btn">Save Note</button>
              <button id="downloadImg" class="btn-ghost">Download Image</button>
            </div>
          </div>
        </div>

        <aside>
          <div style="text-align:center">
            <div style="margin-bottom:8px"><strong>QR for this image</strong></div>
            <img id="qrPreview" src="" alt="QR" style="width:220px;height:220px;border:1px solid #eef6ff;border-radius:8px">
            <div style="margin-top:8px">
              <a id="downloadQR" class="btn-ghost" style="display:inline-block;padding:8px 10px;border-radius:8px;text-decoration:none">Download QR</a>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="small">Actions:</div>
            <div class="controls" style="margin-top:8px">
              <button id="copyLink" class="btn-ghost">Copy Link</button>
              <button id="shareBtn" class="btn">Share (Phone)</button>
            </div>

            <div class="note" style="margin-top:12px">Tip: Print QR on ticket — scan to open photo & notes.</div>
            <div style="margin-top:10px">
              <strong>QR Scanner</strong>
              <div id="qr-reader"></div>
              <div class="note">Open scanner and point camera at QR; page will open that image.</div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

<script>
/* Simple gallery + QR + scanner demo (client-side, localStorage) */
const STORAGE_KEY = 'kgn_gallery_v1';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
state.technicians = state.technicians || [];
state.shop = state.shop || [];
let currentCategory = 'technicians';
let currentIndex = null;

// DOM
const tabs = document.getElementById('tabs');
const grid = document.getElementById('grid');
const pickBtn = document.getElementById('pickBtn');
const fileInput = document.getElementById('fileInput');
const modal = document.getElementById('modal');
const closeModal = document.getElementById('closeModal');
const modalImg = document.getElementById('modalImg');
const modalTitle = document.getElementById('modalTitle');
const modalMeta = document.getElementById('modalMeta');
const modalComment = document.getElementById('modalComment');
const saveComment = document.getElementById('saveComment');
const qrPreview = document.getElementById('qrPreview');
const downloadQR = document.getElementById('downloadQR');
const copyLink = document.getElementById('copyLink');
const shareBtn = document.getElementById('shareBtn');
const downloadImg = document.getElementById('downloadImg');

// util
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function uid(){ return 'id'+Date.now() + Math.floor(Math.random()*99); }
function viewerUrl(id,cat){ return window.location.origin + window.location.pathname + '#img=' + encodeURIComponent(id) + '&cat=' + encodeURIComponent(cat); }
function qrUrlFor(link){ return 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(link); }

// render grid
function renderGrid(){
  grid.innerHTML = '';
  const list = state[currentCategory] || [];
  if(!list.length){ grid.innerHTML = '<div class="card" style="padding:16px">No images yet — use Upload / Take Photo</div>'; return; }
  list.forEach((it, idx)=>{
    const div = document.createElement('div'); div.className='thumb card';
    const img = document.createElement('img'); img.src = it.data; img.alt = it.name || 'image';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = it.name || ('Image ' + (idx+1));
    const note = document.createElement('div'); note.className='small'; note.textContent = it.note ? it.note.substring(0,60) : '';
    const meta = document.createElement('div'); meta.style.display='flex'; meta.style.justifyContent='space-between';
    const open = document.createElement('button'); open.className='btn-ghost'; open.textContent='Open';
    open.addEventListener('click', ()=> openModal(idx));
    const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='Remove';
    del.addEventListener('click', ()=> { if(confirm('Remove this image?')){ state[currentCategory].splice(idx,1); saveState(); renderGrid(); }});
    meta.appendChild(open); meta.appendChild(del);
    div.appendChild(img); div.appendChild(title); div.appendChild(note); div.appendChild(meta);
    grid.appendChild(div);
  });
}

// tabs
tabs.addEventListener('click', e=>{
  const t = e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  currentCategory = t.dataset.cat;
  renderGrid();
});

// upload
pickBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const name = prompt('Name for photo (optional):', f.name) || f.name;
  const reader = new FileReader();
  reader.onload = function(ev){
    const data = ev.target.result;
    state[currentCategory].unshift({ id: uid(), name, data, note:'', created: new Date().toISOString() });
    saveState(); renderGrid(); fileInput.value='';
  };
  reader.readAsDataURL(f);
});

// modal open
function openModal(idx){
  const item = state[currentCategory][idx];
  if(!item) return;
  currentIndex = idx;
  modalImg.src = item.data;
  modalTitle.textContent = item.name || 'Image';
  modalMeta.textContent = 'Uploaded: ' + new Date(item.created).toLocaleString();
  modalComment.value = item.note || '';
  // QR
  const link = viewerUrl(item.id, currentCategory);
  const qr = qrUrlFor(link);
  qrPreview.src = qr;
  downloadQR.href = qr;
  downloadQR.download = (item.name||'img')+'_qr.png';
  copyLink.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(link); alert('Link copied'); } catch(e){ prompt('Copy link:', link); }
  };
  shareBtn.onclick = async ()=>{
    if(navigator.share){ try{ await navigator.share({title:item.name,text:'KGN Mimo Care image',url:link}); }catch(e){alert('Share canceled');} }
    else alert('Share not supported on this device');
  };
  downloadImg.onclick = ()=> { const a=document.createElement('a'); a.href=item.data; a.download=(item.name||'img')+'.png'; a.click(); };
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
}

// save comment
saveComment.addEventListener('click', ()=>{
  if(currentIndex===null) return;
  state[currentCategory][currentIndex].note = modalComment.value.trim();
  saveState(); renderGrid(); alert('Note saved');
});

// close
closeModal.addEventListener('click', ()=> { modal.style.display='none'; modal.setAttribute('aria-hidden','true'); currentIndex=null; });

// hash open handler (scan link opens same page hash)
function checkHash(){
  const h = location.hash;
  if(!h) return;
  const re = /img=([^&]+).*cat=([^&]+)/;
  const m = h.match(re);
  if(!m) return;
  const id = decodeURIComponent(m[1]); const cat = decodeURIComponent(m[2]);
  const list = state[cat] || [];
  const idx = list.findIndex(x=>x.id===id);
  if(idx>=0){ currentCategory=cat; document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x.dataset.cat===cat)); renderGrid(); openModal(idx); }
}
window.addEventListener('hashchange', checkHash);
setTimeout(checkHash,500);

// simple QR scanner using html5-qrcode
let qrScanner = null;
function startScanner(){
  const readerElem = document.getElementById('qr-reader');
  if(qrScanner) return;
  qrScanner = new Html5Qrcode(/* element id */ "qr-reader");
  qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    (decodedText) => {
      // open decoded link
      window.location.href = decodedText;
      qrScanner.stop();
      qrScanner = null;
    },
    (errorMessage) => {
      // ignore
    }).catch(err=>{ console.error('QR start failed', err); alert('Scanner start failed: ' + err.message); });
}

// start scanner when modal opens (optional)
modal.addEventListener('click', (e)=>{
  // if clicked QR area start scan? not needed
});
document.addEventListener('DOMContentLoaded', ()=>{ renderGrid(); });

// for convenience, start scanner region when user clicks the QR preview (so they can scan another QR)
qrPreview.addEventListener('click', ()=> {
  if(confirm('Open QR scanner to scan a QR and open linked image?')) startScanner();
});

</script>
</body>
</html>
